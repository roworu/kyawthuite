---
name: Build disk image
on:
  workflow_dispatch:

env:
  IMAGE_NAME: "${{ github.event.repository.name }}"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"
  DEFAULT_TAG: "latest"

jobs:
  build_release:

    name: Build and release disk image

    strategy:
      fail-fast: false
      matrix:
        flavor: ["", "nvidia"]

    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: read
      id-token: write

    timeout-minutes: 60

    steps:
      - name: Change image name depending on build flavor
        env:
          BUILD_FLAVOR: ${{ matrix.flavor }}
        run: |
          if [ "${BUILD_FLAVOR}" != "" ] ; then
            echo "IMAGE_NAME=${IMAGE_NAME}-${{ matrix.flavor }}" >> $GITHUB_ENV
          fi

      - name: Lower case image variables
        run: |
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Mount BTRFS for podman storage
        id: container-storage-action
        uses: ublue-os/container-storage-action@911baca08baf30c8654933e9e9723cb399892140
        continue-on-error: true
        with:
          target-dir: /var/lib/containers
          mount-opts: compress-force=zstd:2

      - name: Build ISO
        id: build-iso
        uses: osbuild/bootc-image-builder-action@main
        with:
          builder-image: ghcr.io/zena-linux/bootc-image-builder:latest
          config-file: ${{ matrix.flavor == 'nvidia' && './iso-nvidia.toml' || './iso.toml' }}
          image: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}
          types: anaconda-iso
          rootfs: btrfs
          additional-args: --use-librepo=True

      - name: Find ISO to upload
        id: find_iso
        run: |
          ISO_FILE=$(find "${{ steps.build-iso.outputs.output-directory }}" -name "*.iso" | head -n1)
          echo "ISO_FILE=$ISO_FILE" >> $GITHUB_OUTPUT

      - name: Split ISO into 1GB parts
        id: split_iso
        run: |
          mkdir -p ./iso_parts
          split -b 1G "${{ steps.find_iso.outputs.ISO_FILE }}" ./iso_parts/install.part.

      - name: Upload ISO parts to GoFile
        id: upload_parts
        run: |
          set -euo pipefail

          MAX_RETRIES=5

          for part in ./iso_parts/*; do
            echo "Uploading $part ..."

            for attempt in $(seq 1 $MAX_RETRIES); do
              echo "Attempt $attempt/$MAX_RETRIES"

              URL=$(
                curl -s \
                  -F "file=@$part" \
                  https://upload.gofile.io/uploadfile | \
                python3 -c "import sys, json; print(json.load(sys.stdin)['data']['downloadPage'])" \
                || true
              )

              if [ -n "$URL" ]; then
                echo "$URL"
                break
              fi

              if [ "$attempt" -eq "$MAX_RETRIES" ]; then
                echo "Upload failed after $MAX_RETRIES attempts for $part"
                exit 1
              fi

              sleep 3
            done
          done

      - name: Upload Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: ${{ github.event.repository.name }}
          path: ${{ steps.build-iso.outputs.output-directory }}
          if-no-files-found: error
          retention-days: 0
          compression-level: 0
          overwrite: true
